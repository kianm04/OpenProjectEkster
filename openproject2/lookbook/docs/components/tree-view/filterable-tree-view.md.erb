The `FilterableTreeView` is an extended `TreeView` implementation for scenarios where filtering and managing selections within a large tree structure is required. It extends the `TreeView` by introducing filtering and view control options, making it particularly useful for workflows that require selection of nodes from hierarchies.

## Overview

<%= embed OpenProject::Common::FilterableTreeViewPreview, :default %>

## Anatomy

The `FilterableTreeView` consists of the following UI elements:

1. **Segmented Control (optional)**: Allows toggling between viewing all items and only selected ones. Labels and filter logic are configurable
2. **Search Field**: A text field with a leading search icon used to filter the tree content via text
3. **Checkbox "Include sub-nodes" (optional)**: When enabled, checking a parent node will also include its descendants
4. **TreeView**: An embedded `TreeView` component with multi-select enabled and static loading strategy

## Features

### TreeView behavior

The embedded `TreeView` behaves according to its specification, with a few notable constraints and extensions:

- **Loading strategy**: Only supports `static` loading.
- **Multi-select support**: Enabled by default.

For details on the `TreeView` itself, refer to the [TreeView documentation](./tree_view).

---

### Search functionality

The search field enables text-based filtering of the tree.

**Behavior:**

- Partial matches are supported (e.g., `"par"` matches `"partial"`).
- If a **leaf** matches but its ancestors do not, the full hierarchy for that leaf is shown.
- Non-matching nodes in a visible path are **greyed out and disabled** (not clickable).
- Matching characters in results are **highlighted**.

**Single-select considerations:**

- Selections made **before** filtering are preserved, even if they are not visible in the current filter.
- On form submission, **the selected item** is submitted, even if it is currently not shown (e.g filtered out).

**Multi-select considerations:**

- Selections made **before** filtering are preserved, even if they are not visible in the current filter.
- If **"Include sub-nodes"** is enabled:
  - Selecting a parent will select all its descendants, even if they’re hidden due to filtering.
- On form submission, **all selected items** are submitted, including those currently not shown.

---

### Segmented control

A segmented control toggles the visible tree scope:

- **All**: Shows the full tree (default view).
- **Selected**: Shows only selected items and their ancestors.

**Behavior in "Selected" mode:**

- The full path to selected items is shown; non-selected ancestors are **greyed out and disabled**.
- Checking parents will still select all descendants (if "Include sub-nodes" is enabled), not only the visible ones.
- Unchecked items remain visible until the form is submitted or manually reloaded.

**Custom filter logic**

The labels as well as the logic for the segmented control are configurable. For details, please check the technical notes section at the bottom.

The segmented control can be disabled and hidden by passing `hidden: true` as `filter_mode_control_arguments`. Please have a look at [this preview](../../../inspect/primer/open_project/filterable_tree_view/hide_segmented_control) for details.

---

### "Include sub-nodes" checkbox

This checkbox controls whether checking a parent node selects all of its children.

**Behavior:**

- When **checked**:
  - Checking a parent automatically selects and disables all descendants.
  - Unchecking a parent unchecks all children as well.
- When **unchecked again**:
  - The component does **remember** how a selection was made (manual vs. auto). Previously auto-selected descendants get unselected while manually selected items remain selected.

The checkbox can be visually hidden by passing `hidden: true` to the `include_sub_items_check_box_arguments`. The logic remains however. Please have a look at [this preview](../../../inspect/primer/open_project/filterable_tree_view/hide_checkbox) for details.

---

## Best practices

**Do:**

- Use this component when users need to **search and selectively choose** items in a tree.
- Enable **"Include sub-nodes"** if selecting a parent should automatically include all descendants.

**Don't:**

- Don’t use `FilterableTreeView` with a dynamic loading strategy – only static loading is supported.
- Don't use the component for simple hierarchies which don't need filtering; instead use `TreeView`.

## Used in

- (Planned) In the admin settings as a way of selecting projects in which to enable a certain object, like a project attribute, type or custom field.

## Examples

See detailed examples in the [preview section](../../../inspect/primer/open_project/filterable_tree_view/default).

<%= embed OpenProject::Common::FilterableTreeViewPreview, :default, panels: %i[params source] %>

## Technical notes

### Custom select control

In addition to the default filter modes of `'all'` and `'selected'` described above, `FilterableTreeView` supports
adding custom filter modes. Adding a filter mode will cause its label to appear in the `SegmentedControl` in the
toolbar, and will be passed as the third argument to the filter function (see below).

Here's how to add a custom filter mode in addition to the default ones:

```erb
&lt;%= render(Primer::OpenProject::FilterableTreeView.new) do |tree_view| %&gt;
  <%# remove this line to prevent that the default modes "All" and "Selected" are shown %>
  &lt;% tree_view.with_default_filter_modes %&gt;
  &lt;% tree_view.with_filter_mode(name: "Custom third option") %&gt;
&lt;% end %>
```

#### Custom filter function

The filter function can be customized by setting the value of the `filterFn` property to a function with the
following signature:

```typescript
export type FilterFn = (node:HTMLElement, query:string, filterMode?:string) => Range[]|null
```

This function will be called once for each node in the tree every time filter controls change (i.e. when the
filter mode or query string are altered). The function is called with the following arguments:

|Argument    |Description                                                      |
|:-----------|:----------------------------------------------------------------|
|`node`      |The HTML node element, i.e. the element with `role=treeitem` set.|
|`query`     |The query string.                                                |
|`filterMode`|The filter mode, either `'all'` or `'selected'`.                 |

The component expects the filter function to return specific values depending on the type of match:

1. No match - return `null`
2. Match but no highlights (eg. when the query string is empty) - return an empty array
3. Match with highlights - return a non-empty array of `Range` objects

##### Example:

```javascript
const filterableTreeView = document.querySelector('filterable-tree-view')
filterableTreeView.filterFn = (node, query, filterMode) => {
  // custom filter implementation here
}
```

You can read about `Range` objects here: https://developer.mozilla.org/en-US/docs/Web/API/Range.

For a complete example demonstrating how to implement a working filter function complete with range highlighting,
see the default filter function available in the `FilterableTreeViewElement` JavaScript class, which is part of
the Primer source code.
